(function(c,u){typeof exports=="object"&&typeof module<"u"?u(exports,require("fastify-plugin"),require("slonik"),require("humps"),require("@dzangolab/postgres-migrations"),require("zod")):typeof define=="function"&&define.amd?define(["exports","fastify-plugin","slonik","humps","@dzangolab/postgres-migrations","zod"],u):(c=typeof globalThis<"u"?globalThis:c||self,u(c.DzangolabFastifySlonik={},c.FastifyPlugin,c.Slonik,c.Humps,c.DzangolabPostgresMigrations,c.Zod))})(this,function(c,u,e,q,$,f){"use strict";const v={transformRow:(r,t,a,n)=>q.camelizeKeys(a)},D={transformRow:(r,t,a,n)=>{const{resultParser:s}=r;if(!s)return a;const i=s.safeParse(a);if(!i.success)throw new e.SchemaValidationError(t,a,i.error.issues);return i.data}},b=r=>{const t={captureStackTrace:!1,connectionRetryLimit:3,connectionTimeout:5e3,idleInTransactionSessionTimeout:6e4,idleTimeout:5e3,interceptors:[],maximumPoolSize:10,queryRetryLimit:5,statementTimeout:6e4,transactionRetryLimit:5,...r};return t.interceptors=[v,D,...r?.interceptors??[]],t},I=async r=>{const t=r.slonik,a={database:t.db.databaseName,user:t.db.username,password:t.db.password,host:t.db.host,port:t.db.port,ensureDatabaseExists:!0,defaultDatabase:"postgres"},n="migrations";await $.migrate(a,t?.migrations?.path||n)},S=async(r,t)=>{const a=await e.createPool(r,b(t));return{connect:a.connect.bind(a),pool:a,query:a.query.bind(a)}},p=async(r,t)=>{const{connectionString:a,clientConfiguration:n}=t;let s;try{s=await S(a,n),await s.pool.connect(async()=>{r.log.info("âœ… Connected to Postgres DB")})}catch(i){throw r.log.error("ðŸ”´ Error happened while connecting to Postgres DB"),new Error(i)}!r.hasDecorator("slonik")&&!r.hasDecorator("sql")&&(r.decorate("slonik",s),r.decorate("sql",e.sql)),!r.hasRequestDecorator("slonik")&&!r.hasRequestDecorator("sql")&&(r.decorateRequest("slonik",null),r.decorateRequest("sql",null),r.addHook("onRequest",async i=>{i.slonik=s,i.sql=e.sql}))},L=u(p,{fastify:"4.x",name:"fastify-slonik"});u(p,{fastify:"4.x",name:"fastify-slonik"});const w=u(async(r,t,a)=>{const n=r.config.slonik;r.log.info("Registering fastify-slonik plugin"),r.register(L,{connectionString:e.stringifyDsn(n.db),clientConfiguration:b(n?.clientConfiguration)}),r.log.info("Running database migrations"),await I(r.config),a()}),C=(r,t)=>{const a=r.key,n=r.operator||"eq",s=r.not||!1;let i=r.value;const l=e.sql.identifier([...t.names,a]);let o;switch(n){case"ct":case"sw":case"ew":{i={ct:`%${i}%`,ew:`%${i}`,sw:`${i}%`}[n],o=s?e.sql.fragment`NOT ILIKE`:e.sql.fragment`ILIKE`;break}case"eq":default:{o=s?e.sql.fragment`!=`:e.sql.fragment`=`;break}case"gt":{o=s?e.sql.fragment`<`:e.sql.fragment`>`;break}case"gte":{o=s?e.sql.fragment`<`:e.sql.fragment`>=`;break}case"lte":{o=s?e.sql.fragment`>`:e.sql.fragment`<=`;break}case"lt":{o=s?e.sql.fragment`>`:e.sql.fragment`<`;break}case"in":{o=s?e.sql.fragment`NOT IN`:e.sql.fragment`IN`,i=e.sql.fragment`(${e.sql.join(i.split(","),e.sql.fragment`, `)})`;break}case"bt":{o=s?e.sql.fragment`NOT BETWEEN`:e.sql.fragment`BETWEEN`,i=e.sql.fragment`${e.sql.join(i.split(","),e.sql.fragment` AND `)}`;break}}return e.sql.fragment`${l} ${o} ${i}`},N=(r,t,a=!1)=>{const n=[],s=[];let i;const l=(o,g,y=!1)=>{if(o.AND)for(const m of o.AND)l(m,g);else if(o.OR)for(const m of o.OR)l(m,g,!0);else{const m=C(o,g);y?s.push(m):n.push(m)}};return l(r,t,a),n.length>0&&s.length>0?i=e.sql.join([e.sql.fragment`(${e.sql.join(n,e.sql.fragment` AND `)})`,e.sql.fragment`(${e.sql.join(s,e.sql.fragment` OR `)})`],e.sql.fragment`${r.AND?e.sql.fragment` AND `:e.sql.fragment` OR `}`):n.length>0?i=e.sql.join(n,e.sql.fragment` AND `):s.length>0&&(i=e.sql.join(s,e.sql.fragment` OR `)),i?e.sql.fragment`WHERE ${i}`:e.sql.fragment``},h=(r,t)=>r?N(r,t):e.sql.fragment``,T=(r,t)=>{let a=e.sql.fragment`LIMIT ${r}`;return t&&(a=e.sql.fragment`LIMIT ${r} OFFSET ${t}`),a},E=(r,t)=>{if(t&&t.length>0){const a=[];for(const n of t){const s=n.direction==="ASC"?e.sql.fragment`ASC`:e.sql.fragment`DESC`;a.push(e.sql.fragment`${e.sql.identifier([...r.names,n.key])} ${s}`)}return e.sql.fragment`ORDER BY ${e.sql.join(a,e.sql.fragment`,`)}`}return e.sql.fragment`ORDER BY id ASC`},F=(r,t)=>e.sql.fragment`${d(r,t)}`,d=(r,t)=>e.sql.identifier(t?[t,r]:[r]),O=r=>e.sql.fragment`WHERE id = ${r}`;class R{_service;constructor(t){this._service=t}getAllSql=t=>{const a=[],n={};for(const i of t)a.push(e.sql.identifier([q.decamelize(i)])),n[i]=!0;const s=this.validationSchema._def.typeName==="ZodObject"?this.validationSchema.pick(n):f.z.any();return e.sql.type(s)`
      SELECT ${e.sql.join(a,e.sql.fragment`, `)}
      FROM ${this.getTableFragment()}
      ORDER BY id ASC;
    `};getCreateSql=t=>{const a=[],n=[];for(const s in t){const i=s,l=t[i];a.push(e.sql.identifier([q.decamelize(i)])),n.push(l)}return e.sql.type(this.validationSchema)`
      INSERT INTO ${this.getTableFragment()}
        (${e.sql.join(a,e.sql.fragment`, `)})
      VALUES (${e.sql.join(n,e.sql.fragment`, `)})
      RETURNING *;
    `};getDeleteSql=t=>e.sql.type(this.validationSchema)`
      DELETE FROM ${this.getTableFragment()}
      WHERE id = ${t}
      RETURNING *;
    `;getFindByIdSql=t=>e.sql.type(this.validationSchema)`
      SELECT *
      FROM ${this.getTableFragment()}
      WHERE id = ${t};
    `;getListSql=(t,a,n,s)=>{const i=d(this.table,this.schema);return e.sql.type(this.validationSchema)`
      SELECT *
      FROM ${this.getTableFragment()}
      ${h(n,i)}
      ${E(i,s)}
      ${T(t,a)};
    `};getTableFragment=()=>F(this.table,this.schema);getUpdateSql=(t,a)=>{const n=[];for(const s in a){const i=a[s];n.push(e.sql.fragment`${e.sql.identifier([q.decamelize(s)])} = ${i}`)}return e.sql.type(this.validationSchema)`
      UPDATE ${this.getTableFragment()}
      SET ${e.sql.join(n,e.sql.fragment`, `)}
      WHERE id = ${t}
      RETURNING *;
    `};getCountSql=t=>{const a=d(this.table,this.schema),n=f.z.object({count:f.z.number()});return e.sql.type(n)`
      SELECT COUNT(*)
      FROM ${this.getTableFragment()}
      ${h(t,a)};
    `};get config(){return this.service.config}get database(){return this.service.database}get service(){return this._service}get schema(){return this.service.schema}get table(){return this.service.table}get validationSchema(){return this.service.validationSchema}}class _{static TABLE=void 0;static LIMIT_DEFAULT=20;static LIMIT_MAX=50;_config;_database;_factory;_schema="public";_validationSchema=f.z.any();constructor(t,a,n){this._config=t,this._database=a,n&&(this._schema=n)}all=async t=>{const a=this.factory.getAllSql(t);return await this.database.connect(s=>s.any(a))};create=async t=>{const a=this.factory.getCreateSql(t),n=await this.database.connect(async s=>s.query(a).then(i=>i.rows[0]));return n?this.postCreate(n):void 0};delete=async t=>{const a=this.factory.getDeleteSql(t);return await this.database.connect(s=>s.one(a))};findById=async t=>{const a=this.factory.getFindByIdSql(t);return await this.database.connect(s=>s.maybeOne(a))};getLimitDefault=()=>this.config.slonik?.pagination?.defaultLimit||this.constructor.LIMIT_DEFAULT;getLimitMax=()=>this.config.slonik?.pagination?.maxLimit||this.constructor.LIMIT_MAX;list=async(t,a,n,s)=>{const i=this.factory.getListSql(Math.min(t??this.getLimitDefault(),this.getLimitMax()),a,n,s),[l,o,g]=await Promise.all([this.count(),this.count(n),this.database.connect(y=>y.any(i))]);return{totalCount:l,filteredCount:o,data:g}};count=async t=>{const a=this.factory.getCountSql(t);return(await this.database.connect(s=>s.any(a)))[0].count};update=async(t,a)=>{const n=this.factory.getUpdateSql(t,a);return await this.database.connect(s=>s.query(n).then(i=>i.rows[0]))};get config(){return this._config}get database(){return this._database}get factory(){if(!this.table)throw new Error("Service table is not defined");return this._factory||(this._factory=new R(this)),this.factory}get schema(){return this._schema||"public"}get table(){return this.constructor.TABLE}get validationSchema(){return this._validationSchema||f.z.any()}postCreate=async t=>t}c.BaseService=_,c.DefaultSqlFactory=R,c.createDatabase=S,c.createFilterFragment=h,c.createLimitFragment=T,c.createSortFragment=E,c.createTableFragment=F,c.createTableIdentifier=d,c.createWhereIdFragment=O,c.default=w,Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
